services:
  ros2-moveit2:
    container_name: ros2-moveit2
    build:
      context: .
      dockerfile: ./docker/ros2-moveit2.dockerfile
    environment:
      - __GLX_VENDOR_LIBRARY_NAME=mesa
      - QT_QPA_PLATFORM=xcb
      # Display (WSLg)
      - DISPLAY=:0
      # Prefer Wayland or let Qt auto-select
      # - QT_QPA_PLATFORM=wayland
      # (Uncomment above or leave unset for auto)
      - PULSE_SERVER=/mnt/wslg/PulseServer
      - QT_X11_NO_MITSHM=1
      # Gazebo Harmonic
      - GZ_VERSION=harmonic
      # Mesa d3d12 (WSL2 GPU)
      - GALLIUM_DRIVER=d3d12
      - MESA_LOADER_DRIVER_OVERRIDE=d3d12
      - MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA
      - LIBGL_ALWAYS_SOFTWARE=0
      - LIBGL_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib
      - mesa_glthread=false
      # GPU
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # XDG_RUNTIME_DIR for WSLg/Wayland
      - XDG_RUNTIME_DIR=/tmp/runtime-root
    volumes:
      - /mnt/wslg/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:rw
      - /usr/lib/wsl:/usr/lib/wsl:ro
      - ./workspaces/moveit2_code/src:/root/ws_moveit/src
    devices:
      - /dev/dxg:/dev/dxg
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    privileged: true
    stdin_open: true
    tty: true
    command: sleep infinity
    entrypoint: ["/bin/bash", "-c", "mkdir -p /tmp/runtime-root && chmod 700 /tmp/runtime-root && exec \"$@\"", "--"]
    networks:
      - ros2_net

networks:
  ros2_net:
    driver: bridge
    name: ros2_moveit_net
