version: "3.9"

services:
  ros2-moveit2:
    container_name: ros2-moveit2
    build:
      context: .
      dockerfile: ./docker/ros2-moveit2.dockerfile
    environment:
      # =============================================================================
      # Display Configuration for Docker Desktop on WSL2
      # =============================================================================
      - DISPLAY=:0
      - WAYLAND_DISPLAY=wayland-0
      - XDG_RUNTIME_DIR=/mnt/wslg/runtime-dir
      - PULSE_SERVER=/mnt/wslg/PulseServer
      - QT_X11_NO_MITSHM=1
      # =============================================================================
      # Gazebo Harmonic Configuration
      # Harmonic has the ogre-next fix that resolves Mesa d3d12 rendering issues
      # =============================================================================
      - GZ_VERSION=harmonic
      # =============================================================================
      # WSL2 GPU via Mesa d3d12 driver
      # =============================================================================
      - GALLIUM_DRIVER=d3d12
      - MESA_LOADER_DRIVER_OVERRIDE=d3d12
      - MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA
      - LIBGL_ALWAYS_SOFTWARE=0
      - LIBGL_DRI3_DISABLE=1
      - LIBGL_ALWAYS_INDIRECT=0
      - LIBGL_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib
      # =============================================================================
      # Mesa d3d12 Stability Settings
      # With Harmonic's ogre-next fix, fewer workarounds are needed
      # =============================================================================
      - mesa_glthread=false
      - MESA_NO_ERROR=1
      # =============================================================================
      # NVIDIA GPU capabilities
      # =============================================================================
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    volumes:
      # =============================================================================
      # WSLg Display Paths
      # =============================================================================
      - /mnt/wslg/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:rw
      # =============================================================================
      # WSL GPU Libraries - REQUIRED for d3d12 driver to work
      # =============================================================================
      - /usr/lib/wsl:/usr/lib/wsl:ro
      # --- Your source code (for live editing) ---
      - ./workspaces/moveit2_code/src:/root/ws_moveit/src
    devices:
      # --- WSL2 GPU device (required for d3d12 driver) ---
      - /dev/dxg:/dev/dxg
      # --- DRI render devices ---
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    # =============================================================================
    # Container Settings
    # =============================================================================
    privileged: true
    stdin_open: true
    tty: true
    command: sleep infinity
    networks:
      - ros2_net

networks:
  ros2_net:
    driver: bridge
    name: ros2_moveit_net
