services:
  ros2-moveit2:
    container_name: ros2-moveit2
    build:
      context: .
      dockerfile: ./docker/ros2-moveit2.dockerfile
    environment:
      # Prefer Wayland for WSLg (Xwayland fallback still available via DISPLAY)
      - WAYLAND_DISPLAY=wayland-0
      - XDG_RUNTIME_DIR=/mnt/wslg/runtime-dir
      - QT_QPA_PLATFORM=wayland
      - DISPLAY=:0
      - PULSE_SERVER=/mnt/wslg/PulseServer
      - QT_X11_NO_MITSHM=1
      # Gazebo Harmonic
      - GZ_VERSION=harmonic
      # Mesa d3d12 (WSL2 GPU)
      - GALLIUM_DRIVER=d3d12
      - MESA_LOADER_DRIVER_OVERRIDE=d3d12
      - MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA
      - LIBGL_ALWAYS_SOFTWARE=0
      - LIBGL_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri:/usr/lib/wsl/lib
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib
      - mesa_glthread=false
      # Wayland runtime (root-owned dir inside container with symlink to WSLg socket)
      - XDG_RUNTIME_DIR=/run/user/0
      # GPU
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    volumes:
      - /mnt/wslg/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:rw
      - /usr/lib/wsl:/usr/lib/wsl:ro
      - ./workspaces/moveit2_code/src:/root/ws_moveit/src
    devices:
      - /dev/dxg:/dev/dxg
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    privileged: true
    stdin_open: true
    tty: true
    command: sleep infinity
    entrypoint:
      [
        "/bin/bash",
        "-c",
        "install -d -m700 /run/user/0 && ln -sf /mnt/wslg/runtime-dir/wayland-0 /run/user/0/wayland-0 && exec \"$@\"",
        "--",
      ]
    networks:
      - ros2_net

networks:
  ros2_net:
    driver: bridge
    name: ros2_moveit_net
