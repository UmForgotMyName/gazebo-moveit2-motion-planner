services:
  ros2-moveit2:
    container_name: ros2-moveit2
    build:
      context: .
      dockerfile: ./docker/ros2-moveit2.dockerfile
    environment:
      # X11 and Display Configuration
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - QT_DEBUG_PLUGINS=1
      - XAUTHORITY=/root/.Xauthority
      
      # NVIDIA GPU Configuration
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - __NV_PRIME_RENDER_OFFLOAD=1
      - __GLX_VENDOR_LIBRARY_NAME=nvidia
      
    volumes:
      # X11 socket and authentication
      - "/tmp/.X11-unix:/tmp/.X11-unix:rw"
      - "${XAUTHORITY}:/root/.Xauthority:rw"
      
      # GPU and graphics devices
      - "/dev/dri:/dev/dri:rw"
      - "/dev/nvidia0:/dev/nvidia0:rw"
      - "/dev/nvidiactl:/dev/nvidiactl:rw"
      - "/dev/nvidia-uvm:/dev/nvidia-uvm:rw"
      - "/dev/nvidia-modeset:/dev/nvidia-modeset:rw"
      
      # Workspace
      - "./workspaces/moveit2_code/src:/root/ws_moveit/src"
      
    networks:
      - ros2_humble_net
    privileged: true
    stdin_open: true
    tty: true
    command: sleep infinity
    
    # GPU resource allocation
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, utility, compute, graphics, display]
    
    # Additional runtime options for GPU access
    runtime: nvidia
    
    # Security options for GPU and X11 access
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

networks:
  ros2_humble_net:
    driver: bridge
    name: ros2_humble_net
